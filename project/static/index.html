<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        input, button {
            padding: 10px;
            font-size: 1rem;
            margin-right: 10px;
        }
        button {
            cursor: pointer;
        }
        .section {
            margin-bottom: 40px;
        }
        .results {
            margin-top: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .item {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .item:last-child {
            border-bottom: none;
        }
        
    </style>
</head>
<body>
    <h1>ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ</h1>

    <!-- ë²•ì •ë™ ê²€ìƒ‰ -->
    <div class="section">
        <h2>ë²•ì •ë™ ê²€ìƒ‰</h2>
        <div class="search-container">
            <input
                type="text"
                id="dongInput"
                placeholder="ë²•ì •ë™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                onkeypress="if(event.key === 'Enter') document.getElementById('dongSearchBtn').click();"
            />
            <button id="dongSearchBtn" onclick="searchDong()">ê²€ìƒ‰</button>
            <button id="toggleDongBtn" onclick="toggleDongResults()" style="display: none;">â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°</button>
        </div>
        <div id="dongResultsWrapper" style="margin-top: 10px;">
            <div id="dongResults" class="results" style="display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- ìë™ì…ë ¥ìš© ë²•ì •ë™ì½”ë“œ í•„ë“œ -->
    <div class="section">
        <label for="bubjungdongCode">ë²•ì •ë™ì½”ë“œ:</label>
        <input type="text" id="bubjungdongCode" readonly>
    </div>

    <!-- ì§€í•˜ì²  ê²€ìƒ‰ -->
    <div class="section">
        <h2>ì§€í•˜ì²  ê²€ìƒ‰</h2>
        <div class="search-container">
            <input
                type="text"
                id="subwayInput"
                placeholder="ì§€í•˜ì² ì—­ëª… ë˜ëŠ” ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                onkeypress="if(event.key === 'Enter') document.getElementById('subwaySearchBtn').click();"
            />
            <button id="subwaySearchBtn" onclick="searchSubway()">ê²€ìƒ‰</button>
            <button id="toggleSubwayBtn" onclick="toggleSubwayResults()" style="display: none;">â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°</button>
        </div>
        <div id="subwayResultsWrapper" style="margin-top: 10px;">
            <div id="subwayResults" class="results" style="display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- ìë™ì…ë ¥ìš© ê°œí†µì¼ í•„ë“œ -->
    <div class="section">
        <label for="subwayOpenDateInputForSearch">ê°œí†µì¼:</label>
        <input type="text" id="subwayOpenDateAutoFill" readonly>
    </div>

    <!-- ì•„íŒŒíŠ¸ ê²€ìƒ‰ -->
    <div class="section">
        <h2>ì•„íŒŒíŠ¸ ê²€ìƒ‰</h2>
        <div class="search-container">
            <input
                type="text"
                id="apartmentNameInput"
                placeholder="ì•„íŒŒíŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                onkeypress="if(event.key === 'Enter') document.getElementById('apartmentSearchBtn').click();"
            />
            <button id="apartmentSearchBtn" onclick="searchApartment()">ê²€ìƒ‰</button>
            <button id="toggleApartmentBtn" onclick="toggleApartmentResults()" style="display: none;">â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°</button>
        </div>
        <div id="apartmentResultsWrapper" style="margin-top: 10px;">
            <div id="apartmentResults" class="results" style="display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- ìë™ì…ë ¥ìš© ì•„íŒŒíŠ¸ëª… í•„ë“œ -->
    <div class="section">
        <label for="apartmentName">ì•„íŒŒíŠ¸ëª…:</label>
        <input type="text" id="apartmentName" readonly>
    </div>

<!-- ì „ìš©ë©´ì  ê²€ìƒ‰ -->
<div class="section">
    <h2>ì „ìš©ë©´ì  ê²€ìƒ‰</h2>
    <div class="search-container">
        <input type="text" id="areaCodeInput" placeholder="ë²•ì •ë™ì½”ë“œ (ì˜ˆ: 11680)">
        <input type="text" id="areaDateInput" placeholder="ì§€í•˜ì²  ê°œí†µì¼ (ì˜ˆ: 20250421)">
        <input type="text" id="areaAptInput" placeholder="ì•„íŒŒíŠ¸ëª…">
        <button onclick="searchExclusiveArea()">ê²€ìƒ‰</button>

        <!-- ë¡œë”© ë©”ì‹œì§€ -->
        <div id="exclusiveAreaLoading" style="display: none; font-weight: bold; margin-top: 10px;">
            ğŸ” ì „ìš©ë©´ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ -->
        <button id="toggleAreaResultsButton" onclick="toggleAreaResults()" style="display: none; margin-top: 10px;">
            ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°
        </button>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <table id="exclusiveAreaTable" style="display: none; width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr>
                    <th style="border-bottom: 1px solid #ccc; text-align: left; padding: 8px;">ì „ìš©ë©´ì </th>
                    <th style="border-bottom: 1px solid #ccc; text-align: left; padding: 8px;">ê±°ë˜ íšŸìˆ˜</th>
                </tr>
            </thead>
            <tbody id="exclusiveAreaBody"></tbody>
        </table>
    </div>

    <!-- ìë™ì…ë ¥ìš© ì „ìš©ë©´ì  í•„ë“œ -->
    <div class="section">
        <label for="exclusiveArea">ì „ìš©ë©´ì :</label>
        <input type="text" id="exclusiveArea" readonly>
    </div>


    <script>
        // ë²•ì •ë™ ê²€ìƒ‰
        let lastSelectedDongCode = "";

        async function searchDong() {
            const dong = document.getElementById("dongInput").value.trim();
            const resultsDiv = document.getElementById("dongResults");
            const toggleBtn = document.getElementById("toggleDongBtn");

            resultsDiv.innerHTML = "";
            if (!dong) {
                resultsDiv.innerHTML = "ë²•ì •ë™ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                resultsDiv.style.display = "block";
                toggleBtn.style.display = "block";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
                return;
            }

            resultsDiv.innerHTML = "ê²€ìƒ‰ ì¤‘...";
            resultsDiv.style.display = "block";
            toggleBtn.style.display = "block";
            toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";

            try {
                const response = await fetch(`/bubjungdong/getbubjungdong?dong=${encodeURIComponent(dong)}`);
                const data = await response.json();

                if (data.result && data.resultCount > 0) {
                    resultsDiv.innerHTML = `<p><strong>ê²€ìƒ‰ê²°ê³¼ (${data.resultCount}ê±´)</strong></p>`;
                    data.results.forEach(item => {
                        const div = document.createElement("div");
                        div.className = "dong-result-item";
                        div.innerHTML = `<strong>${item.bubjungdongName}</strong> (${item.bubjungdongCode})<br>íì§€ì—¬ë¶€: ${item.exitOrNot}`;
                        div.onclick = () => selectDongCode(item.bubjungdongCode);
                        resultsDiv.appendChild(div);
                    });
                } else {
                    resultsDiv.innerHTML = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                }
            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        function selectDongCode(code) {
            lastSelectedDongCode = code;
            document.getElementById("bubjungdongCode").value = code;

            // 2. ì•„íŒŒíŠ¸ ê²€ìƒ‰ ì…ë ¥ì°½ì—ë„ ìë™ ì…ë ¥
            document.getElementById("apartmentCodeInput").value = code;
            // âœ… ì„ íƒ í›„ ê²°ê³¼ì°½ ë‹«ê¸°
            document.getElementById("dongResults").style.display = "none";
            document.getElementById("toggleDongBtn").textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
        }

        function toggleDongResults() {
            const results = document.getElementById("dongResults");
            const toggleBtn = document.getElementById("toggleDongBtn");

            if (results.style.display === "none") {
                results.style.display = "block";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
            } else {
                results.style.display = "none";
                toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
        }
        }

        // ì§€í•˜ì²  ê²€ìƒ‰
        async function searchSubway() {
            const query = document.getElementById("subwayInput").value.trim();
            const resultsDiv = document.getElementById("subwayResults");
            const toggleBtn = document.getElementById("toggleSubwayBtn");

            // ê²€ìƒ‰ ì¤‘ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ê²°ê³¼ë¥¼ ë³´ì´ë„ë¡ ì„¤ì •
            resultsDiv.innerHTML = "ê²€ìƒ‰ ì¤‘...";
            resultsDiv.style.display = "block";  // ê²€ìƒ‰ í›„ ê²°ê³¼ê°€ ë³´ì´ê²Œ ì„¤ì •
            toggleBtn.style.display = "block";  // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ í‘œì‹œ

            try {
                const response = await fetch(`/subway/getsubway?station=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.result && data.resultCount > 0) {
                    resultsDiv.innerHTML = `<p><strong>ê²€ìƒ‰ê²°ê³¼ (${data.resultCount}ê±´)</strong></p>`;
                    data.results.forEach(item => {
                        const stationDiv = document.createElement("div");
                        stationDiv.className = "subway-result-item";
                        stationDiv.style.cursor = "pointer";
                        stationDiv.innerHTML = `
                            <strong>${item.stationName}</strong><br>
                            ìœ„ì¹˜: ${item.location}<br>
                            ê°œí†µì¼: ${item.openDate || "ì •ë³´ ì—†ìŒ"}
                        `;
                        stationDiv.onclick = () => {
                            if (item.openDate) {
                                // ì§€í•˜ì²  ê°œí†µì¼ì´ ì¡´ì¬í•˜ë©´ ì•„íŒŒíŠ¸ ê²€ìƒ‰ì¹¸ì— ìë™ìœ¼ë¡œ ì…ë ¥
                                document.getElementById("subwayOpenDateAutoFill").value = item.openDate;
                                document.getElementById("subwayOpenDateInputForSearch").value = item.openDate;
                            }
                            // ê²°ê³¼ì°½ ìˆ¨ê¸°ê¸°
                            resultsDiv.style.display = "none";
                            toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
                            toggleBtn.style.display = "block";
                        };
                        resultsDiv.appendChild(stationDiv);
                    });
                } else {
                    resultsDiv.innerHTML = data.message || "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                }
            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // ì§€í•˜ì²  ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸° / ë‹«ê¸° í† ê¸€ ê¸°ëŠ¥
        function toggleSubwayResults() {
            const results = document.getElementById("subwayResults");
            const toggleBtn = document.getElementById("toggleSubwayBtn");

            // ê²°ê³¼ì°½ì´ ì•ˆ ë³´ì´ë©´ í¼ì¹˜ê³ , ë³´ì´ë©´ ë‹«ê¸°
            if (results.style.display === "none") {
                results.style.display = "block";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
            } else {
                results.style.display = "none";
                toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
            }
        }

        // ì•„íŒŒíŠ¸ ê²€ìƒ‰
        async function searchApartment() {
            const aptName = document.getElementById("apartmentNameInput").value.trim();
            const dongCode = document.getElementById("bubjungdongCode").value.trim();
            const openDate = document.getElementById("subwayOpenDateAutoFill").value.trim();
            const resultsDiv = document.getElementById("apartmentResults");
            const toggleBtn = document.getElementById("toggleApartmentBtn");

            resultsDiv.innerHTML = "";
            resultsDiv.style.display = "block";
            toggleBtn.style.display = "block";
            toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";

            if (!aptName || !dongCode || !openDate) {
                resultsDiv.innerHTML = "ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë²•ì •ë™ì½”ë“œ, ì•„íŒŒíŠ¸ëª…, ê°œí†µì¼)";
                return;
            }

            try {
                const query = `/getaptdeal?bubjungdongCode=${encodeURIComponent(dongCode)}&aptName=${encodeURIComponent(aptName)}&openDate=${encodeURIComponent(openDate)}`;
                const response = await fetch(query);
                const data = await response.json();

                if (data.result && data.result.length > 0) {
                    // ê±°ë˜íšŸìˆ˜ ê³„ì‚°
                    const countMap = new Map();
                    data.result.forEach(item => {
                        const apt = item.ì•„íŒŒíŠ¸ëª…;
                        countMap.set(apt, (countMap.get(apt) || 0) + 1);
                    });

                    resultsDiv.innerHTML = `<p><strong>ê²€ìƒ‰ê²°ê³¼ (${countMap.size}ê±´)</strong></p>`;
                    for (const [apt, count] of countMap.entries()) {
                        const div = document.createElement("div");
                        div.className = "apartment-result-item";
                        div.innerHTML = `${apt} - ê±°ë˜ ${count}ê±´`;
                        resultsDiv.appendChild(div);
                    }
                } else {
                    resultsDiv.innerHTML = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                }
            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        function toggleApartmentResults() {
            const results = document.getElementById("apartmentResults");
            const toggleBtn = document.getElementById("toggleApartmentBtn");

            if (results.style.display === "none") {
                results.style.display = "block";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
            } else {
                results.style.display = "none";
                toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
            }
        }

        // ì „ìš©ë©´ì  ê²€ìƒ‰
        async function searchExclusiveArea() {
            const code = document.getElementById("areaCodeInput").value.trim();
            const date = document.getElementById("areaDateInput").value.trim();
            const aptName = document.getElementById("areaAptInput").value.trim();

            if (!code || !date || !aptName) {
                alert("ë²•ì •ë™ì½”ë“œ, ê°œí†µì¼, ì•„íŒŒíŠ¸ëª…ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            const loading = document.getElementById("exclusiveAreaLoading");
            const table = document.getElementById("exclusiveAreaTable");
            const body = document.getElementById("exclusiveAreaBody");
            const toggleBtn = document.getElementById("toggleAreaResultsButton");

            loading.style.display = "block";
            table.style.display = "none";
            body.innerHTML = "";

            try {
                const res = await fetch(`http://192.168.1.42:5000/getexcluusear?bubjungdongCode=${code}&openDate=${date}&apartmentName=${encodeURIComponent(aptName)}`);
                const data = await res.json();
                loading.style.display = "none";

                if (data.result && data.resultCount > 0) {
                    data.results.forEach(item => {
                        const row = document.createElement("tr");

                        const areaCell = document.createElement("td");
                        areaCell.textContent = item.area;
                        areaCell.style.padding = "8px";
                        areaCell.style.cursor = "pointer";

                        const countCell = document.createElement("td");
                        countCell.textContent = item.tradeCount;
                        countCell.style.padding = "8px";

                        row.appendChild(areaCell);
                        row.appendChild(countCell);

                        // í´ë¦­ ì‹œ ì „ìš©ë©´ì  ìë™ì…ë ¥
                        areaCell.onclick = function () {
                            document.getElementById("exclusiveArea").value = item.area;
                            table.style.display = "none";
                            toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
                        };

                        body.appendChild(row);
                    });

                    table.style.display = "table";
                    toggleBtn.style.display = "inline-block";
                    toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
                } else {
                    const row = document.createElement("tr");
                    const cell = document.createElement("td");
                    cell.colSpan = 2;
                    cell.textContent = data.message || "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    cell.style.color = "red";
                    cell.style.padding = "8px";
                    row.appendChild(cell);
                    body.appendChild(row);
                    table.style.display = "table";
                    toggleBtn.style.display = "inline-block";
                    toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
                }
            } catch (err) {
                loading.style.display = "none";
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 2;
                cell.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + err.message;
                cell.style.color = "red";
                cell.style.padding = "8px";
                row.appendChild(cell);
                body.appendChild(row);
                table.style.display = "table";
                toggleBtn.style.display = "inline-block";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
            }
        }

        // ì „ìš©ë©´ì  ê²€ìƒ‰ ê²°ê³¼ í† ê¸€ ê¸°ëŠ¥
        function toggleAreaResults() {
            const table = document.getElementById("exclusiveAreaTable");
            const toggleBtn = document.getElementById("toggleAreaResultsButton");
            if (table.style.display === "none") {
                table.style.display = "table";
                toggleBtn.textContent = "â–² ê²€ìƒ‰ ê²°ê³¼ ë‹«ê¸°";
            } else {
                table.style.display = "none";
                toggleBtn.textContent = "â–¼ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°";
            }
        }
    </script>

    <style>
        .dong-result-item {
        padding: 6px 10px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        }
        .dong-result-item:hover {
        background-color: #f0f8ff;
        }
    </style>

    <style>
        .subway-result-item {
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .subway-result-item:hover {
            background-color: #f0f8ff;
        }
    </style>

    <style>
        .apartment-result-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
    
        .apartment-result-item:hover {
            background-color: #f0f8ff;
        }
    </style>

    <style>
        .exclusive-result-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .exclusive-result-item:hover {
            background-color: #f0f8ff;
        }
    </style>
</body>
</html>